import 'package:flutter_test/flutter_test.dart';
import 'package:mockito/annotations.dart';
import 'package:mockito/mockito.dart';
import 'package:firebase_auth/firebase_auth.dart';
import 'package:cloud_firestore/cloud_firestore.dart';
import 'package:firebase_storage/firebase_storage.dart';
import 'package:climate_app/features/reporting/providers/reporting_provider.dart';
import 'package:climate_app/core/providers/connectivity_provider.dart';
import 'package:climate_app/core/services/offline_queue_service.dart';

@GenerateMocks([
  FirebaseAuth,
  FirebaseFirestore,
  FirebaseStorage,
  User,
  CollectionReference,
  DocumentReference,
])
import 'reporting_test.mocks.dart';

class MockConnectivityProvider extends Mock implements ConnectivityProvider {
  bool _isOnline = true;
  @override
  bool get isOnline => _isOnline;

  set isOnline(bool value) => _isOnline = value;
}

class MockOfflineQueueService extends Mock implements OfflineQueueService {
  @override
  Future<void> queueOperation(
    QueuedOperationType type,
    Map<String, dynamic> data,
  ) async {
    return;
  }
}

void main() {
  group('ReportingProvider', () {
    late ReportingProvider provider;
    late MockConnectivityProvider mockConnectivity;
    late MockOfflineQueueService mockQueue;
    late MockFirebaseAuth mockAuth;
    late MockFirebaseFirestore mockFirestore;
    late MockFirebaseStorage mockStorage; // Added mockStorage declaration

    setUp(() {
      mockAuth = MockFirebaseAuth();
      mockFirestore = MockFirebaseFirestore();
      mockStorage = MockFirebaseStorage(); // Initialized mockStorage
      mockConnectivity = MockConnectivityProvider();
      mockQueue = MockOfflineQueueService();

      // Inject ALL mocks
      provider = ReportingProvider(
        auth: mockAuth,
        firestore: mockFirestore,
        storage: mockStorage, // Injected mockStorage
        offlineQueue: mockQueue,
      );

      provider.setConnectivityProvider(mockConnectivity);
    });

    test('Initial state is clean', () {
      expect(provider.hazardType, null);
    });

    test('setConnectivityProvider sets the provider', () {
      provider.setConnectivityProvider(mockConnectivity);
    });
  });
}
